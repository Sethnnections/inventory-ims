<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-tachometer-alt"></i> Dashboard
    </h2>
    <span class="badge bg-secondary">Role: <%= user.role %></span>
</div>

<div class="row">
    <!-- Role-based dashboard cards -->
    <% if (user.role === 'admin') { %>
        <div class="col-md-3 mb-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="adminCount">-</h4>
                            <p>Admins</p>
                        </div>
                        <i class="fas fa-user-shield fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    <% } %>
    
    <% if (user.role === 'admin' || user.role === 'manager') { %>
        <div class="col-md-3 mb-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="managerCount">-</h4>
                            <p>Managers</p>
                        </div>
                        <i class="fas fa-user-tie fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    <% } %>
    
    <div class="col-md-3 mb-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="staffCount">-</h4>
                        <p>Staff</p>
                    </div>
                    <i class="fas fa-users fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="productCount">-</h4>
                        <p>Products</p>
                    </div>
                    <i class="fas fa-box fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions based on Role -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <% if (user.role === 'admin') { %>
                        <div class="col-md-3 mb-2">
                            <a href="/admin/users" class="btn btn-outline-primary w-100">
                                <i class="fas fa-users"></i> Manage Users
                            </a>
                        </div>
                    <% } %>
                    
                    <% if (user.role === 'manager' || user.role === 'admin') { %>
                        <div class="col-md-3 mb-2">
                            <a href="/manager/inventory" class="btn btn-outline-success w-100">
                                <i class="fas fa-warehouse"></i> Manage Inventory
                            </a>
                        </div>
                    <% } %>
                    
                    <div class="col-md-3 mb-2">
                        <a href="/staff/products" class="btn btn-outline-info w-100">
                            <i class="fas fa-box"></i> View Products
                        </a>
                    </div>
                    
                    <div class="col-md-3 mb-2">
                        <a href="/profile" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-user"></i> My Profile
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load dashboard statistics using authenticated fetch
async function loadDashboardStats() {
    try {
        // Use the authenticated fetch helper
        const [staffRes, productsRes] = await Promise.all([
            fetch('/api/auth/staffuser', { credentials: 'include' }),
            fetch('/api/product', { credentials: 'include' })
        ]);
        
        // If we get here, responses are ok (auth handler would have redirected)
        const staffData = await staffRes.json();
        document.getElementById('staffCount').textContent = Array.isArray(staffData) ? staffData.length : 0;
        
        // Check user role from server-side variable
        const userRole = '<%= user.role %>';
        
        if (userRole === 'admin' || userRole === 'manager') {
            const managerRes = await fetch('/api/auth/manageruser', { credentials: 'include' });
            const managerData = await managerRes.json();
            document.getElementById('managerCount').textContent = Array.isArray(managerData) ? managerData.length : 0;
        }
        
        if (userRole === 'admin') {
            const adminRes = await fetch('/api/auth/adminuser', { credentials: 'include' });
            const adminData = await adminRes.json();
            document.getElementById('adminCount').textContent = Array.isArray(adminData) ? adminData.length : 0;
        }
        
        const productsData = await productsRes.json();
        document.getElementById('productCount').textContent = Array.isArray(productsData) ? productsData.length : 0;
        
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
        // Auth error handler will redirect if needed
    }
}

document.addEventListener('DOMContentLoaded', loadDashboardStats);
</script>